// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../../generated/prisma/postgres"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_POSTGRES")
}

model User {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  email             String   @unique
  password          String   @db.VarChar(255)
  createdDate       DateTime @default(now()) @map("created_date")
  passwordUpdatedAt DateTime? @map("password_updated_at")
  verified          Boolean  @default(false)

  @@index([email])
  @@map("users")
}

model ContentBank {
  id        BigInt   @id @default(autoincrement())
  userId    String   @map("user_id") @db.Uuid
  name      String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  quizzes      Quiz[]
  contentEntries ContentEntryBank[]

  @@map("content_banks")
}

model Topic {
  id        BigInt   @id @default(autoincrement())
  userId    String   @map("user_id") @db.Uuid
  topic     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  contentEntries ContentEntryTopic[]

  @@unique([userId, topic])
  @@map("topics")
}

enum ContentType {
  selected_text
  full_html
  video_transcript
}

model YouTubeChannel {
  id                BigInt   @id @default(autoincrement())
  channelId  String   @unique @map("channel_id") @db.Text
  channelName       String   @map("channel_name") @db.Text
  avatarUrl         String?  @map("avatar_url") @db.Text
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  contentEntries ContentEntry[]

  @@map("youtube_channels")
}

model ContentEntry {
  id                 BigInt      @id @default(autoincrement())
  contentType        ContentType @map("content_type")
  content            String?     @db.Text
  sourceUrl          String?     @map("source_url") @db.Text
  pageTitle          String?     @map("page_title") @db.Text
  createdAt          DateTime    @default(now()) @map("created_at")
  promptSummary      String?     @map("prompt_summary") @db.Text
  questionsGenerated Boolean     @default(false) @map("questions_generated")
  wordCount          Int?        @map("word_count")
  videoDuration      Int?        @map("video_duration") // Duration in seconds
  youtubeVideoId     String?     @map("youtube_video_id") @db.Text
  youtubeChannelId   BigInt?     @map("youtube_channel_id")

  // Relations
  questions      Question[]
  quizQuestions  QuizQuestion[]
  contentBanks   ContentEntryBank[]
  topics         ContentEntryTopic[]
  youtubeChannel YouTubeChannel?    @relation(fields: [youtubeChannelId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@map("content_entries")
}

model Quiz {
  id                    BigInt    @id @default(autoincrement())
  bankId                BigInt?   @map("bank_id")
  bankName              String?   @map("bank_name")
  createdAt             DateTime  @default(now()) @map("created_at")
  contentEntriesCount   Int       @default(0) @map("content_entries_count")
  questionsCount        Int       @default(0) @map("questions_count")
  questionsCompleted    Int       @default(0) @map("questions_completed")
  completedAt           DateTime? @map("completed_at")
  userId                String?   @map("user_id") @db.Uuid

  // Relations
  contentBank       ContentBank?           @relation(fields: [bankId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  quizTopics        QuizTopic[]
  quizQuestions     QuizQuestion[]
  quizResponses     QuizQuestionResponse[]

  @@map("quizzes")
}

model Question {
  id             BigInt   @id @default(autoincrement())
  question       String   @db.Text
  type           String
  contentEntryId BigInt   @map("content_entry_id")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  contentEntry ContentEntry     @relation(fields: [contentEntryId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  options      QuestionOption[]

  @@map("questions")
}

model QuestionOption {
  id                BigInt  @id @default(autoincrement())
  questionId        BigInt  @map("question_id")
  optionText        String  @map("option_text") @db.Text
  optionExplanation String  @map("option_explanation") @db.Text
  isCorrect         Boolean @default(false) @map("is_correct")

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("question_options")
}

model QuizGenerationInstruction {
  id          BigInt   @id @default(autoincrement())
  instruction String   @db.Text
  userId      String   @unique @map("user_id") @db.Uuid
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations

  @@map("quiz_generation_instructions")
}

model ContentEntryBank {
  id              BigInt @id @default(autoincrement())
  contentEntryId  BigInt @map("content_entry_id")
  contentBankId   BigInt @map("content_bank_id")

  // Relations
  contentEntry ContentEntry @relation(fields: [contentEntryId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  contentBank  ContentBank  @relation(fields: [contentBankId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([contentEntryId, contentBankId])
  @@map("content_entries_bank")
}

model ContentEntryTopic {
  id             BigInt @id @default(autoincrement())
  contentEntryId BigInt @map("content_entry_id")
  topicId        BigInt @map("topic_id")

  // Relations
  contentEntry ContentEntry @relation(fields: [contentEntryId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  topic        Topic        @relation(fields: [topicId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([contentEntryId, topicId])
  @@map("content_entry_topics")
}

model QuizTopic {
  id        BigInt @id @default(autoincrement())
  quizId    BigInt @map("quiz_id")
  topicName String @map("topic_name")

  // Relations
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([quizId, topicName])
  @@map("quiz_topics")
}

model QuizQuestion {
  id                      BigInt  @id @default(autoincrement())
  question                String  @db.Text
  type                    String
  contentEntryType        String  @map("content_entry_type") @db.Text
  contentEntrySourceUrl   String? @map("content_entry_source_url") @db.Text
  contentEntryId          BigInt? @map("content_entry_id")
  quizId                  BigInt  @map("quiz_id")

  // Relations
  quiz         Quiz                   @relation(fields: [quizId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  contentEntry ContentEntry?         @relation(fields: [contentEntryId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  options      QuizQuestionOption[]
  responses    QuizQuestionResponse[]

  @@map("quiz_questions")
}

model QuizQuestionOption {
  id                BigInt  @id @default(autoincrement())
  quizQuestionId    BigInt  @map("quiz_question_id")
  optionText        String  @map("option_text") @db.Text
  optionExplanation String  @map("option_explanation") @db.Text
  isCorrect         Boolean @default(false) @map("is_correct")

  // Relations
  quizQuestion QuizQuestion           @relation(fields: [quizQuestionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  responses    QuizQuestionResponse[]

  @@map("quiz_question_options")
}

model QuizQuestionResponse {
  id                     BigInt   @id @default(autoincrement())
  quizId                 BigInt   @map("quiz_id")
  quizQuestionId         BigInt   @map("quiz_question_id")
  quizQuestionOptionId   BigInt   @map("quiz_question_option_id")
  isCorrect              Boolean  @map("is_correct")
  correctAnswer          String   @map("correct_answer") @db.Text
  responseTime           String   @map("response_time") // Using String for interval type

  // Relations
  quiz               Quiz               @relation(fields: [quizId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  quizQuestion       QuizQuestion       @relation(fields: [quizQuestionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  quizQuestionOption QuizQuestionOption @relation(fields: [quizQuestionOptionId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("quiz_question_responses")
}
